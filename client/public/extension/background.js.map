{
  "version": 3,
  "sources": ["../../../extension_src/background.ts"],
  "sourcesContent": ["/// <reference types=\"chrome\"/>\n\n// Gromit Bridge Background Script v4.0.0 (Unified Sanctuary - Offscreen)\n// Supports: OLLAMA_FETCH, EXTRACT_AND_ANALYZE (Proxied), GET_VERSION\n\nconst BRIDGE_VERSION = '4.0.0';\nconst OFFSCREEN_DOCUMENT_PATH = 'offscreen.html';\n\n// Global state\nlet activeSessions = 0;\nlet creating: Promise<void> | null = null;\n\n// Handle long-lived connections from content scripts (GROMIT_SESSION)\nchrome.runtime.onConnect.addListener((port) => {\n    if (port.name === \"GROMIT_SESSION\") {\n        console.log(\"[GromitBridge] \u26A1 Session Port Connected.\");\n        activeSessions++;\n        port.onDisconnect.addListener(() => {\n            activeSessions--;\n            console.log(`[GromitBridge] \uD83D\uDCF4 Session Port Disconnected (Remaining: ${activeSessions}).`);\n            if (activeSessions <= 0) {\n                closeOffscreenDocument();\n            }\n        });\n    }\n});\n\n// --- LIFECYCLE MANAGEMENT (SESSION BASED) ---\n\nasync function closeOffscreenDocument() {\n    if (!creating) {\n        try {\n            await chrome.offscreen.closeDocument();\n            console.log(`[GromitBridge] \uD83D\uDED1 Offscreen Document Closed. Session Ended (Active Sessions: ${activeSessions}).`);\n        } catch (err) {\n            console.debug('[GromitBridge] Offscreen already closed or invalid.');\n        }\n    }\n}\n\n\n\nasync function setupOffscreenDocument(path: string) {\n    // Reset timer whenever we \"touch\" the offscreen doc\n\n\n    // Check if an offscreen document has already been created\n    const offscreenUrl = chrome.runtime.getURL(path);\n    const existingContexts = await chrome.runtime.getContexts({\n        contextTypes: [chrome.runtime.ContextType.OFFSCREEN_DOCUMENT],\n        documentUrls: [offscreenUrl]\n    });\n\n    if (existingContexts.length > 0) {\n        return;\n    }\n\n    // create offscreen document\n    if (creating) {\n        await creating;\n    } else {\n        creating = chrome.offscreen.createDocument({\n            url: path,\n            reasons: [chrome.offscreen.Reason.DOM_PARSER],\n            justification: 'Parsing PDF and other document formats requires a full DOM environment.'\n        });\n        await creating;\n        creating = null;\n    }\n}\n\nchrome.runtime.onMessage.addListener((request: any, sender: any, sendResponse: any) => {\n    // Refresh timer on any valid activity\n\n\n    // --- GET_VERSION: Returns bridge version ---\n    if (request.type === 'GET_VERSION') {\n        sendResponse({ version: BRIDGE_VERSION });\n        return true;\n    }\n\n    // --- EXTRACT_AND_ANALYZE: The new \"Sanctuary\" logic (via Offscreen) ---\n    if (request.type === 'EXTRACT_AND_ANALYZE') {\n        (async () => {\n            try {\n                await setupOffscreenDocument(OFFSCREEN_DOCUMENT_PATH);\n\n                // Forward message to offscreen document\n                console.log('[GromitBridge] Forwarding extraction request to Offscreen Document...');\n                const response = await chrome.runtime.sendMessage({\n                    type: 'EXTRACT_FROM_OFFSCREEN',\n                    fileBase64: request.fileBase64,\n                    fileName: request.fileName,\n                    fileType: request.fileType\n                });\n\n                sendResponse(response);\n            } catch (error: any) {\n                console.error('[GromitBridge] Offscreen Proxy Error:', error);\n                sendResponse({ success: false, error: error.message });\n            }\n        })();\n        return true; // Keep channel open\n    }\n\n    // --- OLLAMA_FETCH: Simple fetch proxy ---\n    if (request.type === 'OLLAMA_FETCH') {\n        const { url, options } = request;\n\n        console.log('[GromitBridge] Eseguo fetch (Background):', url);\n\n        const fetchOptions: any = {\n            method: options.method || 'GET',\n            headers: {\n                'Content-Type': 'application/json'\n            },\n            body: options.body,\n            mode: 'cors',\n            credentials: 'omit',\n            referrerPolicy: 'no-referrer'\n        };\n\n        fetch(url, fetchOptions)\n            .then(async response => {\n                const ok = response.ok;\n                const status = response.status;\n                const data = await response.json().catch(() => ({}));\n                sendResponse({ success: true, ok, status, data });\n            })\n            .catch(error => {\n                console.error('[GromitBridge] Errore Fetch:', error);\n                sendResponse({ success: false, error: error.message });\n            });\n\n        return true;\n    }\n\n});\n"],
  "mappings": "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",
  "names": []
}
